<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Consume Websocket stream and send to Prometheus in Python | blacklabnz | Data | DevOps</title><meta name=keywords content="websocket,prometheus,python"><meta name=description content="Recently I was tasked with consuming data from websocket, analyse it and then send data to Prometheus. The theory is pretty straight forward: getting data from websocket API in a stream and analyse and take the data points and send it to prometheus for visulization. In this blog you will have all the steps and code needed to reporduce this flow. With this in mind, I decided using python to achieve all these."><meta name=author content="blacklabnz"><link rel=canonical href=https://blacklabnz.github.io/posts/websocket-prometheus/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.f6842ebe97a00de4a8021d8be2e0b4f41e33a99badd1890455dad33221128ee0.css integrity="sha256-9oQuvpegDeSoAh2L4uC09B4zqZut0YkEVdrTMiESjuA=" rel="preload stylesheet" as=style><link rel=icon href=https://blacklabnz.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://blacklabnz.github.io/favicon16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blacklabnz.github.io/favicon32x32.png><link rel=mask-icon href=https://blacklabnz.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=G-FDV12HCDKK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FDV12HCDKK",{anonymize_ip:!1})}</script><meta property="og:title" content="Consume Websocket stream and send to Prometheus in Python"><meta property="og:description" content="Recently I was tasked with consuming data from websocket, analyse it and then send data to Prometheus. The theory is pretty straight forward: getting data from websocket API in a stream and analyse and take the data points and send it to prometheus for visulization. In this blog you will have all the steps and code needed to reporduce this flow. With this in mind, I decided using python to achieve all these."><meta property="og:type" content="article"><meta property="og:url" content="https://blacklabnz.github.io/posts/websocket-prometheus/"><meta property="og:image" content="https://blacklabnz.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-18T23:39:13+13:00"><meta property="article:modified_time" content="2022-03-18T23:39:13+13:00"><meta property="og:site_name" content="blacklabnz"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blacklabnz.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Consume Websocket stream and send to Prometheus in Python"><meta name=twitter:description content="Recently I was tasked with consuming data from websocket, analyse it and then send data to Prometheus. The theory is pretty straight forward: getting data from websocket API in a stream and analyse and take the data points and send it to prometheus for visulization. In this blog you will have all the steps and code needed to reporduce this flow. With this in mind, I decided using python to achieve all these."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blacklabnz.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Consume Websocket stream and send to Prometheus in Python","item":"https://blacklabnz.github.io/posts/websocket-prometheus/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Consume Websocket stream and send to Prometheus in Python","name":"Consume Websocket stream and send to Prometheus in Python","description":"Recently I was tasked with consuming data from websocket, analyse it and then send data to Prometheus. The theory is pretty straight forward: getting data from websocket API in a stream and analyse and take the data points and send it to prometheus for visulization. In this blog you will have all the steps and code needed to reporduce this flow. With this in mind, I decided using python to achieve all these.","keywords":["websocket","prometheus","python"],"articleBody":"Recently I was tasked with consuming data from websocket, analyse it and then send data to Prometheus. The theory is pretty straight forward: getting data from websocket API in a stream and analyse and take the data points and send it to prometheus for visulization. In this blog you will have all the steps and code needed to reporduce this flow. With this in mind, I decided using python to achieve all these.\nPart 1. Websocket VS Rest reminder Before we start, I would like to have a bit of revision on Websocket API and how it is different from REST API\nThe diagram I took from internet explains it quite well. In simple term, you interact with REST API with a request and response fashion wheraes in websocket there is a two way connection established during interaction lifecycle therefore you dont need to constantly send request to server for retrieving data. At the end of the interaction, the two way connection is close.\nPart 2. Consuming a websocket API You could easily find some publicly availabel websocket API, the one I used for this blog is from Binance, one of the platform used by coin traders. Though myself is not doing any coin trading nor receiving any sponsorship from them. They have very detailed API documentation on their Spot API.\nThe following code snippet can be used to connect to websocket API:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  import json import websocket socket = \"wss://stream.binance.com:9443/ws/bnbusdt@kline_1m\" def on_message(ws, message): data = json.loads(message) print(data) def on_error(ws, error): print(error) def on_close(ws, close_status_code, close_msg): print(\"Connection closed\") def on_open(ws): print(\"Opened connection\") ws = websocket.WebSocketApp( socket, on_open=on_open, on_message=on_message, on_error=on_error, on_close=on_close ) ws.run_forever()   Quick explanation Line 4 defines the websocket url, the details of this endpoint can be found here. ‚Äú/bnbusdt@kline_1m‚Äù means retrieving data from the kline stream for bnb vs usdt, what is so called a symbol, these are cyrypto coin terminologies which you can fine richer explanations else where.\nLine 6 to line 17 defines the callback function with minimal functionality when message is received from the server. More details can be found in websocket-client official documentation.\nLine 19 and 10 creates a websocket instance and start connection and run forever.\nRun the above python code will give you this console output:\n1 2 3 4 5  Opened connection {\"e\": \"kline\", \"E\": 1647220248756, \"s\": \"BNBUSDT\", \"k\": {\"t\": 1647220200000, \"T\": 1647220259999, \"s\": \"BNBUSDT\", \"i\": \"1m\", \"f\": 527449288, \"L\": 527449503, \"o\": \"364.60000000\", \"c\": \"364.30000000\", \"h\": \"364.60000000\", \"l\": \"364.20000000\", \"v\": \"458.54400000\", \"n\": 216, \"x\": False, \"q\": \"167076.68030000\", \"V\": \"183.99400000\", \"Q\": \"67043.53500000\", \"B\": \"0\"}} {\"e\": \"kline\", \"E\": 1647220251279, \"s\": \"BNBUSDT\", \"k\": {\"t\": 1647220200000, \"T\": 1647220259999, \"s\": \"BNBUSDT\", \"i\": \"1m\", \"f\": 527449288, \"L\": 527449507, \"o\": \"364.60000000\", \"c\": \"364.30000000\", \"h\": \"364.60000000\", \"l\": \"364.20000000\", \"v\": \"460.67000000\", \"n\": 220, \"x\": False, \"q\": \"167851.03680000\", \"V\": \"184.66700000\", \"Q\": \"67288.70890000\", \"B\": \"0\"}} {\"e\": \"kline\", \"E\": 1647220253583, \"s\": \"BNBUSDT\", \"k\": {\"t\": 1647220200000, \"T\": 1647220259999, \"s\": \"BNBUSDT\", \"i\": \"1m\", \"f\": 527449288, \"L\": 527449513, \"o\": \"364.60000000\", \"c\": \"364.20000000\", \"h\": \"364.60000000\", \"l\": \"364.20000000\", \"v\": \"461.78000000\", \"n\": 226, \"x\": False, \"q\": \"168255.38670000\", \"V\": \"185.54600000\", \"Q\": \"67608.92860000\", \"B\": \"0\"}} Connection closed   Futher explore the API Previous step works fine with a single symbol, what if in the websocket I need data from more symbol or even in any websockets ?? The websockert API kindly offers subscription mode, with which you can subscribe multiple symbols and get the data back within the same websocket connection. refer to the following code for this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  import json import websocket socket = \"wss://stream.binance.com:9443/ws\" ws = websocket.create_connection(socket) ws.send(json.dumps({ \"method\": \"SUBSCRIBE\", \"params\": [ \"btcusdt@kline_1m\", \"bnbusdt@kline_1m\", \"ethusdt@kline_1m\", \"dogeusdt@kline_1m\", \"xrpusdt@kline_1m\" ], \"id\": 1 })) def on_message(message): data = json.loads(message) print(data) while True: result = ws.recv() on_message(result) ws.close()   Quick explanation Line 6-17 creates a websocket connection, the first action is to send a message to endpoint to subscribe to steams that are of interests. The playload of the subscription is like this:\n1 2 3 4 5 6 7 8 9 10 11  { \"method\": \"SUBSCRIBE\", \"params\": [ \"btcusdt@kline_1m\", \"bnbusdt@kline_1m\", \"ethusdt@kline_1m\", \"dogeusdt@kline_1m\", \"xrpusdt@kline_1m\" ], \"id\": 1 }   According to the API doc, the response of the first ws.sent(payload) call is\n1 2 3 4  { \"result\": null, \"id\": 1 }   When we inspect the console output when running the above python code we also get the following which indicates we are NOT doing something crazy !\n1 2 3 4  {\"result\": \"None\", \"id\": 1} {\"e\": \"kline\", \"E\": 1647220380568, \"s\": \"XRPUSDT\", \"k\": {\"t\": 1647220320000, \"T\": 1647220379999, \"s\": \"XRPUSDT\", \"i\": \"1m\", \"f\": 429501724, \"L\": 429501859, \"o\": \"0.75860000\", \"c\": \"0.75920000\", \"h\": \"0.75920000\", \"l\": \"0.75860000\", \"v\": \"81089.00000000\", \"n\": 136, \"x\": true, \"q\": \"61541.60570000\", \"V\": \"63081.00000000\", \"Q\": \"47874.45210000\", \"B\": \"0\"}} {\"e\": \"kline\", \"E\": 1647220382238, \"s\": \"BTCUSDT\", \"k\": {\"t\": 1647220380000, \"T\": 1647220439999, \"s\": \"BTCUSDT\", \"i\": \"1m\", \"f\": 1291349545, \"L\": 1291349561, \"o\": \"38183.79000000\", \"c\": \"38183.79000000\", \"h\": \"38183.80000000\", \"l\": \"38183.79000000\", \"v\": \"0.25519000\", \"n\": 17, \"x\": false, \"q\": \"9744.12173000\", \"V\": \"0.03599000\", \"Q\": \"1374.23496200\", \"B\": \"0\"}} {\"e\": \"kline\", \"E\": 1647220382372, \"s\": \"BNBUSDT\", \"k\": {\"t\": 1647220380000, \"T\": 1647220439999, \"s\": \"BNBUSDT\", \"i\": \"1m\", \"f\": 527450005, \"L\": 527450009, \"o\": \"363.80000000\", \"c\": \"363.70000000\", \"h\": \"363.80000000\", \"l\": \"363.70000000\", \"v\": \"2.58200000\", \"n\": 5, \"x\": false, \"q\": \"939.30620000\", \"V\": \"2.32800000\", \"Q\": \"846.92640000\", \"B\": \"0\"}}   As you could see from the screenshot, the first response from the server is the acknowledgement of the subscription. The data following the acknowledgement is the data for the symbols(remember the crypto trading jargon?), and indead we are receiving data for all the symbols we have subscribed to !\nPart 3. Add prometheus-client and create metric endpiont To start with part, first we want to add prometheus client to our code so that we could see metric being sent.\nRecall the follow symbol data output from our previous step:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  { \"e\": \"kline\", // Event type  \"E\": 123456789, // Event time  \"s\": \"BNBBTC\", // Symbol  \"k\": { \"t\": 123400000, // Kline start time  \"T\": 123460000, // Kline close time  \"s\": \"BNBBTC\", // Symbol  \"i\": \"1m\", // Interval  \"f\": 100, // First trade ID  \"L\": 200, // Last trade ID  \"o\": \"0.0010\", // Open price  \"c\": \"0.0020\", // Close price  \"h\": \"0.0025\", // High price  \"l\": \"0.0015\", // Low price  \"v\": \"1000\", // Base asset volume  \"n\": 100, // Number of trades  \"x\": false, // Is this kline closed?  \"q\": \"1.0000\", // Quote asset volume  \"V\": \"500\", // Taker buy base asset volume  \"Q\": \"0.500\", // Taker buy quote asset volume  \"B\": \"123456\" // Ignore  } }   With reference to the doc, for our case we are interested in ‚Äúl‚Äù and ‚Äúh‚Äù in the ‚Äúk‚Äù property for the low price and high price. Obviously we are interested in the ‚Äús‚Äù property as well for the name of the symbol. Once we understand what we need to do with our data, now it time to update the callback function accordingly to do our ‚Äúanalysis‚Äù. Our analysis here is as simple as just reading some properties and this is not very important here as it is on the business side in the real world, our goal in this blog is to retrieve the data and send to Prometheus and we can just send some properties as if it is our ‚Äúanalysis‚Äù. So let\"s go\n1 2 3 4 5 6  def on_message(message): data = json.loads(message) if \"k\" not in data: pass else: print(data[\"s\"], data[\"k\"][\"l\"], data[\"k\"][\"h\"])   Once call back function is updated we should see the following output that captures properties we are interested\n1 2 3 4 5 6  BTCUSDT 38155.15000000 38170.16000000 ETHUSDT 2534.36000000 2535.02000000 XRPUSDT 0.76010000 0.76040000 BNBUSDT 364.40000000 364.50000000 DOGEUSDT 0.11180000 0.11180000 BTCUSDT 38153.01000000 38170.16000000   Now lets start ingesting data to Prometheus using prometheus-client. Obviously we can spent our whole night trying to understand the nitty gritty of prometheus-client, but that is not the purpose right ? Our purpose here is to the things going end to end from websocket to prometheus. So let\"s grab just what we need for this excercise !\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  import json import websocket from prometheus_client import Gauge, start_http_server g= Gauge(\"SymbolPrice\", \"Symbol high and low price\", [\"symbols\"]) start_http_server(8000) def on_message(message): data = json.loads(message) if \"k\" not in data: pass else: print(data[\"s\"], data[\"k\"][\"l\"], data[\"k\"][\"h\"]) g.labels(f\"{data[\"s\"]}-high\").set(data[\"k\"][\"h\"]) g.labels(f\"{data[\"s\"]}-low\").set(data[\"k\"][\"l\"])   Quick explanation Line 5 create a Gauge object, a Guage is a type of metrics to record a value. Like mentioned before there are other types of metrics worth exploring, sounds like a place to spend our ‚Äútech time‚Äù.\nLine 6 create a Prometheus endpoint where you could see the metrics at http://localhost:8080.\nWhen you run python code with above updates, you could start the metrics endpoint from http://localhost:8080 and see the following output. When you refresh the page you should be able to see symbol high and low price being updated! yay ! üòÄ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  # HELP python_gc_objects_collected_total Objects collected during gc # TYPE python_gc_objects_collected_total counter python_gc_objects_collected_total{generation=\"0\"} 311.0 python_gc_objects_collected_total{generation=\"1\"} 71.0 python_gc_objects_collected_total{generation=\"2\"} 0.0 # HELP python_gc_objects_uncollectable_total Uncollectable object found during GC # TYPE python_gc_objects_uncollectable_total counter python_gc_objects_uncollectable_total{generation=\"0\"} 0.0 python_gc_objects_uncollectable_total{generation=\"1\"} 0.0 python_gc_objects_uncollectable_total{generation=\"2\"} 0.0 # HELP python_gc_collections_total Number of times this generation was collected # TYPE python_gc_collections_total counter python_gc_collections_total{generation=\"0\"} 41.0 python_gc_collections_total{generation=\"1\"} 3.0 python_gc_collections_total{generation=\"2\"} 0.0 # HELP python_info Python platform information # TYPE python_info gauge python_info{implementation=\"CPython\",major=\"3\",minor=\"9\",patchlevel=\"0\",version=\"3.9.0\"} 1.0 # HELP SymbolPrice Symbol high and low price # TYPE SymbolPrice gauge SymbolPrice{symbols=\"BNBUSDT-high\"} 363.2 SymbolPrice{symbols=\"BNBUSDT-low\"} 363.0 SymbolPrice{symbols=\"XRPUSDT-high\"} 0.7599 SymbolPrice{symbols=\"XRPUSDT-low\"} 0.7591 SymbolPrice{symbols=\"ETHUSDT-high\"} 2525.16 SymbolPrice{symbols=\"ETHUSDT-low\"} 2523.81 SymbolPrice{symbols=\"BTCUSDT-high\"} 37984.81 SymbolPrice{symbols=\"BTCUSDT-low\"} 37971.19 SymbolPrice{symbols=\"DOGEUSDT-high\"} 0.1113 SymbolPrice{symbols=\"DOGEUSDT-low\"} 0.1112   Obvioiusly you could run docker cmd for this, I have also got a docker-compose.yml here as well.\n1 2 3 4 5 6 7 8  version:\"3.9\"services:prometheus:image:prom/prometheusports:- \"9090:9090\"volumes:- /pathofown/prometheus.yml:/etc/prometheus/prometheus.yml  Before running this you will also need a prometheus configuration file with the name of ‚Äúprometheus.yml‚Äù, in a nutshell in this file you will specify the metrics endpoint from where the server is going to collect data from. When running the Prometheus container, you need to mount the volume for you Prometheus container so that this config file is place in ‚Äú/etc/prometheus/prometheus.yml‚Äù at container runtime.\n1 2 3 4 5 6 7 8 9 10 11  global:scrape_interval:5sevaluation_interval:5sscrape_configs:- job_name:\"prome-local\"static_configs:- targets:[\"localhost:9090\"]- job_name:\"TestJob\"static_configs:- targets:[\"host.docker.internal:8000\"]  Quick explanation Line 8 specifies the port of Prometheus server running locally Line 11 specifies the port and DNS name of the metric endpoint created in Part 3. Note the dns is ‚Äúhosrt.docker.internal‚Äù, this worked for me when running containers with Docker Destop.\nLets start Docker Desktop and run Prometheus server locally either using docker cmd or docker-compose at choice of yours. When navigating to http://localhost:9090/targetsÔºåvoil√† ÔºÅBoth the Prometheus server and the Metric endpoints for the websocekt are up and running !\nAs you can see both of the jobs that you specified in the prometheus.yml file are running !\nWhen navigate back to the graph page, you can easily enter ‚ÄúsymbolPrice‚Äù in the search box and hit execute. You then should be able to see a graph like the following and you can highligh different lables to see the price change for each of the symbols. In may case I selected ‚ÄúBNBUSDT-high‚Äù\nCongratulations! You\"v just reach the end of this blog, I know right ? It is a rather long blog to read, but at least I found the excercis pretty interesting and when you see the graph in Prometheus, it somewhat feeling really comforting !\nThanks for you patience, see you at my next blog !!\n","wordCount":"1958","inLanguage":"en","datePublished":"2022-03-18T23:39:13+13:00","dateModified":"2022-03-18T23:39:13+13:00","author":{"@type":"Person","name":"blacklabnz"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blacklabnz.github.io/posts/websocket-prometheus/"},"publisher":{"@type":"Organization","name":"blacklabnz | Data | DevOps","logo":{"@type":"ImageObject","url":"https://blacklabnz.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><ul><i class="fas fa-terminal"></i></ul><ul><a href=https://blacklabnz.github.io/ accesskey=h title="blacklabnz | Data | DevOps (Alt + H)">blacklabnz | Data | DevOps</a></ul><ul><span id=cursor></span></ul></div><ul id=menu><li><a href=https://blacklabnz.github.io/posts title=blogs><span>blogs</span></a></li><li><a href=https://blacklabnz.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://blacklabnz.github.io/about/ title=about><span>about</span></a></li><li><a href=https://www.linkedin.com/in/neilxu/ target=_blank><i class="fab fa-linkedin-in fa-lg"></i></a></li><li><a href=https://github.com/blacklabnz target=_blank><i class="fab fa-github fa-lg"></i></a></li><span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<i class="fas fa-lightbulb"></i></button></span></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blacklabnz.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://blacklabnz.github.io/posts/>Posts</a></div><h1 class=post-title>Consume Websocket stream and send to Prometheus in Python</h1><div class=post-meta><span title="2022-03-18 23:39:13 +1300 +1300">March 18, 2022</span>&nbsp;¬∑&nbsp;10 min&nbsp;¬∑&nbsp;blacklabnz&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/websocket-prometheus.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#part-1-websocket-vs-rest-reminder aria-label="Part 1. Websocket VS Rest reminder">Part 1. Websocket VS Rest reminder</a></li><li><a href=#part-2-consuming-a-websocket-api aria-label="Part 2. Consuming a websocket API">Part 2. Consuming a websocket API</a><ul><li><a href=#quick-explanation aria-label="Quick explanation">Quick explanation</a></li><li><a href=#futher-explore-the-api aria-label="Futher explore the API">Futher explore the API</a></li><li><a href=#quick-explanation-1 aria-label="Quick explanation">Quick explanation</a></li></ul></li><li><a href=#part-3-add-prometheus-client-and-create-metric-endpiont aria-label="Part 3. Add prometheus-client and create metric endpiont">Part 3. Add prometheus-client and create metric endpiont</a><ul><li><a href=#quick-explanation-2 aria-label="Quick explanation">Quick explanation</a></li><li><a href=#quick-explanation-3 aria-label="Quick explanation">Quick explanation</a></li></ul></li></ul></div></details></div><div class=post-content><p>Recently I was tasked with consuming data from websocket, analyse it and then send data to Prometheus.
The theory is pretty straight forward: getting data from websocket API in a stream and analyse and take the data points and send it to prometheus for visulization.
In this blog you will have all the steps and code needed to reporduce this flow.
With this in mind, I decided using python to achieve all these.</p><h2 id=part-1-websocket-vs-rest-reminder>Part 1. Websocket VS Rest reminder<a hidden class=anchor aria-hidden=true href=#part-1-websocket-vs-rest-reminder>#</a></h2><p>Before we start, I would like to have a bit of revision on Websocket API and how it is different from REST API</p><p><img loading=lazy src=/posts/websocket-prometheus/websocketvsrest.png alt=websocketvsrest></p><p>The diagram I took from internet explains it quite well. In simple term, you interact with REST API with a request and response fashion wheraes in websocket there is a two way connection established during interaction lifecycle therefore you dont need to constantly send request to server for retrieving data. At the end of the interaction, the two way connection is close.</p><h2 id=part-2-consuming-a-websocket-api>Part 2. Consuming a websocket API<a hidden class=anchor aria-hidden=true href=#part-2-consuming-a-websocket-api>#</a></h2><p>You could easily find some publicly availabel websocket API, the one I used for this blog is from Binance, one of the platform used by coin traders. Though myself is not doing any coin trading nor receiving any sponsorship from them.
They have very detailed API documentation on their <a href=https://github.com/binance/binance-spot-api-docs>Spot API</a>.</p><p>The following code snippet can be used to connect to websocket API:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>websocket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>socket</span> <span class=o>=</span> <span class=s2>&#34;wss://stream.binance.com:9443/ws/bnbusdt@kline_1m&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_message</span><span class=p>(</span><span class=n>ws</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_error</span><span class=p>(</span><span class=n>ws</span><span class=p>,</span> <span class=n>error</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_close</span><span class=p>(</span><span class=n>ws</span><span class=p>,</span> <span class=n>close_status_code</span><span class=p>,</span> <span class=n>close_msg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Connection closed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_open</span><span class=p>(</span><span class=n>ws</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Opened connection&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ws</span> <span class=o>=</span> <span class=n>websocket</span><span class=o>.</span><span class=n>WebSocketApp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>socket</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>on_open</span><span class=o>=</span><span class=n>on_open</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>on_message</span><span class=o>=</span><span class=n>on_message</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>on_error</span><span class=o>=</span><span class=n>on_error</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>on_close</span><span class=o>=</span><span class=n>on_close</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ws</span><span class=o>.</span><span class=n>run_forever</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=quick-explanation>Quick explanation<a hidden class=anchor aria-hidden=true href=#quick-explanation>#</a></h3><p>Line 4 defines the websocket url, the details of this endpoint can be found <a href=https://github.com/binance/binance-spot-api-docs/blob/master/web-socket-streams.md#klinecandlestick-streams>here</a>.
&ldquo;/bnbusdt@kline_1m&rdquo; means retrieving data from the kline stream for bnb vs usdt, what is so called a symbol, these are cyrypto coin terminologies which you can fine richer explanations else where.</p><p>Line 6 to line 17 defines the callback function with minimal functionality when message is received from the server.
More details can be found in <a href=https://websocket-client.readthedocs.io/en/latest/>websocket-client</a> official documentation.</p><p>Line 19 and 10 creates a websocket instance and start connection and run forever.</p><p>Run the above python code will give you this console output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>Opened</span> <span class=n>connection</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s2>&#34;e&#34;</span><span class=p>:</span> <span class=s2>&#34;kline&#34;</span><span class=p>,</span> <span class=s2>&#34;E&#34;</span><span class=p>:</span> <span class=mi>1647220248756</span><span class=p>,</span> <span class=s2>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBUSDT&#34;</span><span class=p>,</span> <span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;t&#34;</span><span class=p>:</span> <span class=mi>1647220200000</span><span class=p>,</span> <span class=s2>&#34;T&#34;</span><span class=p>:</span> <span class=mi>1647220259999</span><span class=p>,</span> <span class=s2>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBUSDT&#34;</span><span class=p>,</span> <span class=s2>&#34;i&#34;</span><span class=p>:</span> <span class=s2>&#34;1m&#34;</span><span class=p>,</span> <span class=s2>&#34;f&#34;</span><span class=p>:</span> <span class=mi>527449288</span><span class=p>,</span> <span class=s2>&#34;L&#34;</span><span class=p>:</span> <span class=mi>527449503</span><span class=p>,</span> <span class=s2>&#34;o&#34;</span><span class=p>:</span> <span class=s2>&#34;364.60000000&#34;</span><span class=p>,</span> <span class=s2>&#34;c&#34;</span><span class=p>:</span> <span class=s2>&#34;364.30000000&#34;</span><span class=p>,</span> <span class=s2>&#34;h&#34;</span><span class=p>:</span> <span class=s2>&#34;364.60000000&#34;</span><span class=p>,</span> <span class=s2>&#34;l&#34;</span><span class=p>:</span> <span class=s2>&#34;364.20000000&#34;</span><span class=p>,</span> <span class=s2>&#34;v&#34;</span><span class=p>:</span> <span class=s2>&#34;458.54400000&#34;</span><span class=p>,</span> <span class=s2>&#34;n&#34;</span><span class=p>:</span> <span class=mi>216</span><span class=p>,</span> <span class=s2>&#34;x&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;q&#34;</span><span class=p>:</span> <span class=s2>&#34;167076.68030000&#34;</span><span class=p>,</span> <span class=s2>&#34;V&#34;</span><span class=p>:</span> <span class=s2>&#34;183.99400000&#34;</span><span class=p>,</span> <span class=s2>&#34;Q&#34;</span><span class=p>:</span> <span class=s2>&#34;67043.53500000&#34;</span><span class=p>,</span> <span class=s2>&#34;B&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s2>&#34;e&#34;</span><span class=p>:</span> <span class=s2>&#34;kline&#34;</span><span class=p>,</span> <span class=s2>&#34;E&#34;</span><span class=p>:</span> <span class=mi>1647220251279</span><span class=p>,</span> <span class=s2>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBUSDT&#34;</span><span class=p>,</span> <span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;t&#34;</span><span class=p>:</span> <span class=mi>1647220200000</span><span class=p>,</span> <span class=s2>&#34;T&#34;</span><span class=p>:</span> <span class=mi>1647220259999</span><span class=p>,</span> <span class=s2>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBUSDT&#34;</span><span class=p>,</span> <span class=s2>&#34;i&#34;</span><span class=p>:</span> <span class=s2>&#34;1m&#34;</span><span class=p>,</span> <span class=s2>&#34;f&#34;</span><span class=p>:</span> <span class=mi>527449288</span><span class=p>,</span> <span class=s2>&#34;L&#34;</span><span class=p>:</span> <span class=mi>527449507</span><span class=p>,</span> <span class=s2>&#34;o&#34;</span><span class=p>:</span> <span class=s2>&#34;364.60000000&#34;</span><span class=p>,</span> <span class=s2>&#34;c&#34;</span><span class=p>:</span> <span class=s2>&#34;364.30000000&#34;</span><span class=p>,</span> <span class=s2>&#34;h&#34;</span><span class=p>:</span> <span class=s2>&#34;364.60000000&#34;</span><span class=p>,</span> <span class=s2>&#34;l&#34;</span><span class=p>:</span> <span class=s2>&#34;364.20000000&#34;</span><span class=p>,</span> <span class=s2>&#34;v&#34;</span><span class=p>:</span> <span class=s2>&#34;460.67000000&#34;</span><span class=p>,</span> <span class=s2>&#34;n&#34;</span><span class=p>:</span> <span class=mi>220</span><span class=p>,</span> <span class=s2>&#34;x&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;q&#34;</span><span class=p>:</span> <span class=s2>&#34;167851.03680000&#34;</span><span class=p>,</span> <span class=s2>&#34;V&#34;</span><span class=p>:</span> <span class=s2>&#34;184.66700000&#34;</span><span class=p>,</span> <span class=s2>&#34;Q&#34;</span><span class=p>:</span> <span class=s2>&#34;67288.70890000&#34;</span><span class=p>,</span> <span class=s2>&#34;B&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s2>&#34;e&#34;</span><span class=p>:</span> <span class=s2>&#34;kline&#34;</span><span class=p>,</span> <span class=s2>&#34;E&#34;</span><span class=p>:</span> <span class=mi>1647220253583</span><span class=p>,</span> <span class=s2>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBUSDT&#34;</span><span class=p>,</span> <span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;t&#34;</span><span class=p>:</span> <span class=mi>1647220200000</span><span class=p>,</span> <span class=s2>&#34;T&#34;</span><span class=p>:</span> <span class=mi>1647220259999</span><span class=p>,</span> <span class=s2>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBUSDT&#34;</span><span class=p>,</span> <span class=s2>&#34;i&#34;</span><span class=p>:</span> <span class=s2>&#34;1m&#34;</span><span class=p>,</span> <span class=s2>&#34;f&#34;</span><span class=p>:</span> <span class=mi>527449288</span><span class=p>,</span> <span class=s2>&#34;L&#34;</span><span class=p>:</span> <span class=mi>527449513</span><span class=p>,</span> <span class=s2>&#34;o&#34;</span><span class=p>:</span> <span class=s2>&#34;364.60000000&#34;</span><span class=p>,</span> <span class=s2>&#34;c&#34;</span><span class=p>:</span> <span class=s2>&#34;364.20000000&#34;</span><span class=p>,</span> <span class=s2>&#34;h&#34;</span><span class=p>:</span> <span class=s2>&#34;364.60000000&#34;</span><span class=p>,</span> <span class=s2>&#34;l&#34;</span><span class=p>:</span> <span class=s2>&#34;364.20000000&#34;</span><span class=p>,</span> <span class=s2>&#34;v&#34;</span><span class=p>:</span> <span class=s2>&#34;461.78000000&#34;</span><span class=p>,</span> <span class=s2>&#34;n&#34;</span><span class=p>:</span> <span class=mi>226</span><span class=p>,</span> <span class=s2>&#34;x&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;q&#34;</span><span class=p>:</span> <span class=s2>&#34;168255.38670000&#34;</span><span class=p>,</span> <span class=s2>&#34;V&#34;</span><span class=p>:</span> <span class=s2>&#34;185.54600000&#34;</span><span class=p>,</span> <span class=s2>&#34;Q&#34;</span><span class=p>:</span> <span class=s2>&#34;67608.92860000&#34;</span><span class=p>,</span> <span class=s2>&#34;B&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span> <span class=n>closed</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=futher-explore-the-api>Futher explore the API<a hidden class=anchor aria-hidden=true href=#futher-explore-the-api>#</a></h3><p>Previous step works fine with a single symbol, what if in the websocket I need data from more symbol or even in any websockets ??
The websockert API kindly offers subscription mode, with which you can subscribe multiple symbols and get the data back within the same websocket connection. refer to the following code for this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>websocket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>socket</span> <span class=o>=</span> <span class=s2>&#34;wss://stream.binance.com:9443/ws&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ws</span> <span class=o>=</span> <span class=n>websocket</span><span class=o>.</span><span class=n>create_connection</span><span class=p>(</span><span class=n>socket</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ws</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;SUBSCRIBE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;params&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;btcusdt@kline_1m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bnbusdt@kline_1m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ethusdt@kline_1m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;dogeusdt@kline_1m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;xrpusdt@kline_1m&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_message</span><span class=p>(</span><span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>ws</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>on_message</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ws</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=quick-explanation-1>Quick explanation<a hidden class=anchor aria-hidden=true href=#quick-explanation-1>#</a></h3><p>Line 6-17 creates a websocket connection, the first action is to send a message to endpoint to subscribe to steams that are of interests.
The playload of the subscription is like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;SUBSCRIBE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;btcusdt@kline_1m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bnbusdt@kline_1m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ethusdt@kline_1m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;dogeusdt@kline_1m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;xrpusdt@kline_1m&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>According to the <a href=https://github.com/binance/binance-spot-api-docs/blob/master/web-socket-streams.md#live-subscribingunsubscribing-to-streams>API doc</a>, the response of the first ws.sent(payload) call is</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;result&#34;</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>When we inspect the console output when running the above python code we also get the following which indicates we are NOT doing something crazy !</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;result&#34;</span><span class=p>:</span> <span class=s2>&#34;None&#34;</span><span class=p>,</span> <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;e&#34;</span><span class=p>:</span> <span class=s2>&#34;kline&#34;</span><span class=p>,</span> <span class=nt>&#34;E&#34;</span><span class=p>:</span> <span class=mi>1647220380568</span><span class=p>,</span> <span class=nt>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;XRPUSDT&#34;</span><span class=p>,</span> <span class=nt>&#34;k&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;t&#34;</span><span class=p>:</span> <span class=mi>1647220320000</span><span class=p>,</span> <span class=nt>&#34;T&#34;</span><span class=p>:</span> <span class=mi>1647220379999</span><span class=p>,</span> <span class=nt>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;XRPUSDT&#34;</span><span class=p>,</span> <span class=nt>&#34;i&#34;</span><span class=p>:</span> <span class=s2>&#34;1m&#34;</span><span class=p>,</span> <span class=nt>&#34;f&#34;</span><span class=p>:</span> <span class=mi>429501724</span><span class=p>,</span> <span class=nt>&#34;L&#34;</span><span class=p>:</span> <span class=mi>429501859</span><span class=p>,</span> <span class=nt>&#34;o&#34;</span><span class=p>:</span> <span class=s2>&#34;0.75860000&#34;</span><span class=p>,</span> <span class=nt>&#34;c&#34;</span><span class=p>:</span> <span class=s2>&#34;0.75920000&#34;</span><span class=p>,</span> <span class=nt>&#34;h&#34;</span><span class=p>:</span> <span class=s2>&#34;0.75920000&#34;</span><span class=p>,</span> <span class=nt>&#34;l&#34;</span><span class=p>:</span> <span class=s2>&#34;0.75860000&#34;</span><span class=p>,</span> <span class=nt>&#34;v&#34;</span><span class=p>:</span> <span class=s2>&#34;81089.00000000&#34;</span><span class=p>,</span> <span class=nt>&#34;n&#34;</span><span class=p>:</span> <span class=mi>136</span><span class=p>,</span> <span class=nt>&#34;x&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nt>&#34;q&#34;</span><span class=p>:</span> <span class=s2>&#34;61541.60570000&#34;</span><span class=p>,</span> <span class=nt>&#34;V&#34;</span><span class=p>:</span> <span class=s2>&#34;63081.00000000&#34;</span><span class=p>,</span> <span class=nt>&#34;Q&#34;</span><span class=p>:</span> <span class=s2>&#34;47874.45210000&#34;</span><span class=p>,</span> <span class=nt>&#34;B&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;e&#34;</span><span class=p>:</span> <span class=s2>&#34;kline&#34;</span><span class=p>,</span> <span class=nt>&#34;E&#34;</span><span class=p>:</span> <span class=mi>1647220382238</span><span class=p>,</span> <span class=nt>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BTCUSDT&#34;</span><span class=p>,</span> <span class=nt>&#34;k&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;t&#34;</span><span class=p>:</span> <span class=mi>1647220380000</span><span class=p>,</span> <span class=nt>&#34;T&#34;</span><span class=p>:</span> <span class=mi>1647220439999</span><span class=p>,</span> <span class=nt>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BTCUSDT&#34;</span><span class=p>,</span> <span class=nt>&#34;i&#34;</span><span class=p>:</span> <span class=s2>&#34;1m&#34;</span><span class=p>,</span> <span class=nt>&#34;f&#34;</span><span class=p>:</span> <span class=mi>1291349545</span><span class=p>,</span> <span class=nt>&#34;L&#34;</span><span class=p>:</span> <span class=mi>1291349561</span><span class=p>,</span> <span class=nt>&#34;o&#34;</span><span class=p>:</span> <span class=s2>&#34;38183.79000000&#34;</span><span class=p>,</span> <span class=nt>&#34;c&#34;</span><span class=p>:</span> <span class=s2>&#34;38183.79000000&#34;</span><span class=p>,</span> <span class=nt>&#34;h&#34;</span><span class=p>:</span> <span class=s2>&#34;38183.80000000&#34;</span><span class=p>,</span> <span class=nt>&#34;l&#34;</span><span class=p>:</span> <span class=s2>&#34;38183.79000000&#34;</span><span class=p>,</span> <span class=nt>&#34;v&#34;</span><span class=p>:</span> <span class=s2>&#34;0.25519000&#34;</span><span class=p>,</span> <span class=nt>&#34;n&#34;</span><span class=p>:</span> <span class=mi>17</span><span class=p>,</span> <span class=nt>&#34;x&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nt>&#34;q&#34;</span><span class=p>:</span> <span class=s2>&#34;9744.12173000&#34;</span><span class=p>,</span> <span class=nt>&#34;V&#34;</span><span class=p>:</span> <span class=s2>&#34;0.03599000&#34;</span><span class=p>,</span> <span class=nt>&#34;Q&#34;</span><span class=p>:</span> <span class=s2>&#34;1374.23496200&#34;</span><span class=p>,</span> <span class=nt>&#34;B&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;e&#34;</span><span class=p>:</span> <span class=s2>&#34;kline&#34;</span><span class=p>,</span> <span class=nt>&#34;E&#34;</span><span class=p>:</span> <span class=mi>1647220382372</span><span class=p>,</span> <span class=nt>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBUSDT&#34;</span><span class=p>,</span> <span class=nt>&#34;k&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;t&#34;</span><span class=p>:</span> <span class=mi>1647220380000</span><span class=p>,</span> <span class=nt>&#34;T&#34;</span><span class=p>:</span> <span class=mi>1647220439999</span><span class=p>,</span> <span class=nt>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBUSDT&#34;</span><span class=p>,</span> <span class=nt>&#34;i&#34;</span><span class=p>:</span> <span class=s2>&#34;1m&#34;</span><span class=p>,</span> <span class=nt>&#34;f&#34;</span><span class=p>:</span> <span class=mi>527450005</span><span class=p>,</span> <span class=nt>&#34;L&#34;</span><span class=p>:</span> <span class=mi>527450009</span><span class=p>,</span> <span class=nt>&#34;o&#34;</span><span class=p>:</span> <span class=s2>&#34;363.80000000&#34;</span><span class=p>,</span> <span class=nt>&#34;c&#34;</span><span class=p>:</span> <span class=s2>&#34;363.70000000&#34;</span><span class=p>,</span> <span class=nt>&#34;h&#34;</span><span class=p>:</span> <span class=s2>&#34;363.80000000&#34;</span><span class=p>,</span> <span class=nt>&#34;l&#34;</span><span class=p>:</span> <span class=s2>&#34;363.70000000&#34;</span><span class=p>,</span> <span class=nt>&#34;v&#34;</span><span class=p>:</span> <span class=s2>&#34;2.58200000&#34;</span><span class=p>,</span> <span class=nt>&#34;n&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=nt>&#34;x&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nt>&#34;q&#34;</span><span class=p>:</span> <span class=s2>&#34;939.30620000&#34;</span><span class=p>,</span> <span class=nt>&#34;V&#34;</span><span class=p>:</span> <span class=s2>&#34;2.32800000&#34;</span><span class=p>,</span> <span class=nt>&#34;Q&#34;</span><span class=p>:</span> <span class=s2>&#34;846.92640000&#34;</span><span class=p>,</span> <span class=nt>&#34;B&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>}}</span>
</span></span></code></pre></td></tr></table></div></div><p>As you could see from the screenshot, the first response from the server is the acknowledgement of the subscription.
The data following the acknowledgement is the data for the symbols(remember the crypto trading jargon?), and indead we are receiving data for all the symbols we have subscribed to !</p><h2 id=part-3-add-prometheus-client-and-create-metric-endpiont>Part 3. Add prometheus-client and create metric endpiont<a hidden class=anchor aria-hidden=true href=#part-3-add-prometheus-client-and-create-metric-endpiont>#</a></h2><p>To start with part, first we want to add prometheus client to our code so that we could see metric being sent.</p><p>Recall the follow symbol data output from our previous step:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;e&#34;</span><span class=p>:</span> <span class=s2>&#34;kline&#34;</span><span class=p>,</span>     <span class=c1>// Event type
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nt>&#34;E&#34;</span><span class=p>:</span> <span class=mi>123456789</span><span class=p>,</span>   <span class=c1>// Event time
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nt>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBBTC&#34;</span><span class=p>,</span>    <span class=c1>// Symbol
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nt>&#34;k&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;t&#34;</span><span class=p>:</span> <span class=mi>123400000</span><span class=p>,</span> <span class=c1>// Kline start time
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;T&#34;</span><span class=p>:</span> <span class=mi>123460000</span><span class=p>,</span> <span class=c1>// Kline close time
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;s&#34;</span><span class=p>:</span> <span class=s2>&#34;BNBBTC&#34;</span><span class=p>,</span>  <span class=c1>// Symbol
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;i&#34;</span><span class=p>:</span> <span class=s2>&#34;1m&#34;</span><span class=p>,</span>      <span class=c1>// Interval
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;f&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>       <span class=c1>// First trade ID
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;L&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span>       <span class=c1>// Last trade ID
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;o&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0010&#34;</span><span class=p>,</span>  <span class=c1>// Open price
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;c&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0020&#34;</span><span class=p>,</span>  <span class=c1>// Close price
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;h&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0025&#34;</span><span class=p>,</span>  <span class=c1>// High price
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;l&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0015&#34;</span><span class=p>,</span>  <span class=c1>// Low price
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;v&#34;</span><span class=p>:</span> <span class=s2>&#34;1000&#34;</span><span class=p>,</span>    <span class=c1>// Base asset volume
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;n&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>       <span class=c1>// Number of trades
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;x&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>     <span class=c1>// Is this kline closed?
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;q&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0000&#34;</span><span class=p>,</span>  <span class=c1>// Quote asset volume
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;V&#34;</span><span class=p>:</span> <span class=s2>&#34;500&#34;</span><span class=p>,</span>     <span class=c1>// Taker buy base asset volume
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;Q&#34;</span><span class=p>:</span> <span class=s2>&#34;0.500&#34;</span><span class=p>,</span>   <span class=c1>// Taker buy quote asset volume
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;B&#34;</span><span class=p>:</span> <span class=s2>&#34;123456&#34;</span>   <span class=c1>// Ignore
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>With reference to the <a href=https://github.com/binance/binance-spot-api-docs/blob/master/web-socket-streams.md#klinecandlestick-streams>doc</a>, for our case we are interested in &ldquo;l&rdquo; and &ldquo;h&rdquo; in the &ldquo;k&rdquo; property for the low price and high price. Obviously we are interested in the &ldquo;s&rdquo; property as well for the name of the symbol.
Once we understand what we need to do with our data, now it time to update the callback function accordingly to do our &ldquo;analysis&rdquo;.
Our analysis here is as simple as just reading some properties and this is not very important here as it is on the business side in the real world, our goal in this blog is to retrieve the data and send to Prometheus and we can just send some properties as if it is our &ldquo;analysis&rdquo;. So let"s go</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_message</span><span class=p>(</span><span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;k&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;s&#34;</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;k&#34;</span><span class=p>][</span><span class=s2>&#34;l&#34;</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;k&#34;</span><span class=p>][</span><span class=s2>&#34;h&#34;</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><p>Once call back function is updated we should see the following output that captures properties we are interested</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>BTCUSDT</span> <span class=mf>38155.15000000</span> <span class=mf>38170.16000000</span>
</span></span><span class=line><span class=cl><span class=n>ETHUSDT</span> <span class=mf>2534.36000000</span> <span class=mf>2535.02000000</span>
</span></span><span class=line><span class=cl><span class=n>XRPUSDT</span> <span class=mf>0.76010000</span> <span class=mf>0.76040000</span>
</span></span><span class=line><span class=cl><span class=n>BNBUSDT</span> <span class=mf>364.40000000</span> <span class=mf>364.50000000</span>
</span></span><span class=line><span class=cl><span class=n>DOGEUSDT</span> <span class=mf>0.11180000</span> <span class=mf>0.11180000</span>
</span></span><span class=line><span class=cl><span class=n>BTCUSDT</span> <span class=mf>38153.01000000</span> <span class=mf>38170.16000000</span>
</span></span></code></pre></td></tr></table></div></div><p>Now lets start ingesting data to Prometheus using <a href=https://pypi.org/project/prometheus-client>prometheus-client</a>.
Obviously we can spent our whole night trying to understand the nitty gritty of prometheus-client, but that is not the purpose right ? Our purpose here is to the things going end to end from websocket to prometheus. So let"s grab just what we need for this excercise !</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>websocket</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>prometheus_client</span> <span class=kn>import</span> <span class=n>Gauge</span><span class=p>,</span> <span class=n>start_http_server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>g</span><span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span><span class=s2>&#34;SymbolPrice&#34;</span><span class=p>,</span> <span class=s2>&#34;Symbol high and low price&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;symbols&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>start_http_server</span><span class=p>(</span><span class=mi>8000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_message</span><span class=p>(</span><span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;k&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;s&#34;</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;k&#34;</span><span class=p>][</span><span class=s2>&#34;l&#34;</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;k&#34;</span><span class=p>][</span><span class=s2>&#34;h&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>      <span class=n>g</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;s&#34;</span><span class=p>]</span><span class=si>}</span><span class=s2>-high&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;k&#34;</span><span class=p>][</span><span class=s2>&#34;h&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>      <span class=n>g</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;s&#34;</span><span class=p>]</span><span class=si>}</span><span class=s2>-low&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;k&#34;</span><span class=p>][</span><span class=s2>&#34;l&#34;</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=quick-explanation-2>Quick explanation<a hidden class=anchor aria-hidden=true href=#quick-explanation-2>#</a></h3><p>Line 5 create a Gauge object, a Guage is a type of metrics to record a value. Like mentioned before there are other types of metrics worth exploring, sounds like a place to spend our &ldquo;tech time&rdquo;.</p><p>Line 6 create a Prometheus endpoint where you could see the metrics at http://localhost:8080.</p><p>When you run python code with above updates, you could start the metrics endpoint from http://localhost:8080 and see the following output. When you refresh the page you should be able to see symbol high and low price being updated!
yay ! üòÄ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># HELP python_gc_objects_collected_total Objects collected during gc</span>
</span></span><span class=line><span class=cl><span class=c1># TYPE python_gc_objects_collected_total counter</span>
</span></span><span class=line><span class=cl>python_gc_objects_collected_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;0&#34;</span><span class=o>}</span> 311.0
</span></span><span class=line><span class=cl>python_gc_objects_collected_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=o>}</span> 71.0
</span></span><span class=line><span class=cl>python_gc_objects_collected_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;2&#34;</span><span class=o>}</span> 0.0
</span></span><span class=line><span class=cl><span class=c1># HELP python_gc_objects_uncollectable_total Uncollectable object found during GC</span>
</span></span><span class=line><span class=cl><span class=c1># TYPE python_gc_objects_uncollectable_total counter</span>
</span></span><span class=line><span class=cl>python_gc_objects_uncollectable_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;0&#34;</span><span class=o>}</span> 0.0
</span></span><span class=line><span class=cl>python_gc_objects_uncollectable_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=o>}</span> 0.0
</span></span><span class=line><span class=cl>python_gc_objects_uncollectable_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;2&#34;</span><span class=o>}</span> 0.0
</span></span><span class=line><span class=cl><span class=c1># HELP python_gc_collections_total Number of times this generation was collected</span>
</span></span><span class=line><span class=cl><span class=c1># TYPE python_gc_collections_total counter</span>
</span></span><span class=line><span class=cl>python_gc_collections_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;0&#34;</span><span class=o>}</span> 41.0
</span></span><span class=line><span class=cl>python_gc_collections_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=o>}</span> 3.0
</span></span><span class=line><span class=cl>python_gc_collections_total<span class=o>{</span><span class=nv>generation</span><span class=o>=</span><span class=s2>&#34;2&#34;</span><span class=o>}</span> 0.0
</span></span><span class=line><span class=cl><span class=c1># HELP python_info Python platform information</span>
</span></span><span class=line><span class=cl><span class=c1># TYPE python_info gauge</span>
</span></span><span class=line><span class=cl>python_info<span class=o>{</span><span class=nv>implementation</span><span class=o>=</span><span class=s2>&#34;CPython&#34;</span>,major<span class=o>=</span><span class=s2>&#34;3&#34;</span>,minor<span class=o>=</span><span class=s2>&#34;9&#34;</span>,patchlevel<span class=o>=</span><span class=s2>&#34;0&#34;</span>,version<span class=o>=</span><span class=s2>&#34;3.9.0&#34;</span><span class=o>}</span> 1.0
</span></span><span class=line><span class=cl><span class=c1># HELP SymbolPrice Symbol high and low price</span>
</span></span><span class=line><span class=cl><span class=c1># TYPE SymbolPrice gauge</span>
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;BNBUSDT-high&#34;</span><span class=o>}</span> 363.2
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;BNBUSDT-low&#34;</span><span class=o>}</span> 363.0
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;XRPUSDT-high&#34;</span><span class=o>}</span> 0.7599
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;XRPUSDT-low&#34;</span><span class=o>}</span> 0.7591
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;ETHUSDT-high&#34;</span><span class=o>}</span> 2525.16
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;ETHUSDT-low&#34;</span><span class=o>}</span> 2523.81
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;BTCUSDT-high&#34;</span><span class=o>}</span> 37984.81
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;BTCUSDT-low&#34;</span><span class=o>}</span> 37971.19
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;DOGEUSDT-high&#34;</span><span class=o>}</span> 0.1113
</span></span><span class=line><span class=cl>SymbolPrice<span class=o>{</span><span class=nv>symbols</span><span class=o>=</span><span class=s2>&#34;DOGEUSDT-low&#34;</span><span class=o>}</span> 0.1112
</span></span></code></pre></td></tr></table></div></div><p>Obvioiusly you could run docker cmd for this, I have also got a docker-compose.yml here as well.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.9&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;9090:9090&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/pathofown/prometheus.yml:/etc/prometheus/prometheus.yml</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Before running this you will also need a prometheus configuration file with the name of &ldquo;prometheus.yml&rdquo;, in a nutshell in this file you will specify the metrics endpoint from where the server is going to collect data from. When running the Prometheus container, you need to mount the <a href=https://docs.docker.com/storage/volumes/>volume</a> for you Prometheus container so that this config file is place in &ldquo;/etc/prometheus/prometheus.yml&rdquo; at container runtime.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w>     </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>evaluation_interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;prome-local&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;localhost:9090&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TestJob&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;host.docker.internal:8000&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=quick-explanation-3>Quick explanation<a hidden class=anchor aria-hidden=true href=#quick-explanation-3>#</a></h3><p>Line 8 specifies the port of Prometheus server running locally
Line 11 specifies the port and DNS name of the metric endpoint created in Part 3. Note the dns is &ldquo;hosrt.docker.internal&rdquo;, this worked for me when running containers with <a href=https://www.docker.com/products/docker-desktop>Docker Destop</a>.</p><p>Lets start Docker Desktop and run Prometheus server locally either using docker cmd or docker-compose at choice of yours.
When navigating to http://localhost:9090/targetsÔºåvoil√† ÔºÅBoth the Prometheus server and the Metric endpoints for the websocekt are up and running !</p><p><img loading=lazy src=/posts/websocket-prometheus/prometheus1.png alt=prometheus1></p><p>As you can see both of the jobs that you specified in the prometheus.yml file are running !</p><p>When navigate back to the graph page, you can easily enter &ldquo;symbolPrice&rdquo; in the search box and hit execute. You then should be able to see a graph like the following and you can highligh different lables to see the price change for each of the symbols. In may case I selected &ldquo;BNBUSDT-high&rdquo;</p><p><img loading=lazy src=/posts/websocket-prometheus/prometheus2.png alt=prometheus2></p><p>Congratulations! You"v just reach the end of this blog, I know right ? It is a rather long blog to read, but at least I found the excercis pretty interesting and when you see the graph in Prometheus, it somewhat feeling really comforting !</p><p>Thanks for you patience, see you at my next blog !!</p></div><footer class=post-footer><ul class=post-tags><li><i class="fas fa-tags fa-sm"></i></li><li><a href=https://blacklabnz.github.io/tags/websocket/>websocket</a></li><li><a href=https://blacklabnz.github.io/tags/prometheus/>prometheus</a></li><li><a href=https://blacklabnz.github.io/tags/python/>python</a></li></ul><div class=share-buttons><a>Share via:</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Consume Websocket stream and send to Prometheus in Python on twitter" href="https://twitter.com/intent/tweet/?text=Consume%20Websocket%20stream%20and%20send%20to%20Prometheus%20in%20Python&url=https%3a%2f%2fblacklabnz.github.io%2fposts%2fwebsocket-prometheus%2f&hashtags=websocket%2cprometheus%2cpython"><i class="fab fa-twitter fa-lg"></i></a>
<a target=_blank rel="noopener noreferrer" aria-label="share Consume Websocket stream and send to Prometheus in Python on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblacklabnz.github.io%2fposts%2fwebsocket-prometheus%2f&title=Consume%20Websocket%20stream%20and%20send%20to%20Prometheus%20in%20Python&summary=Consume%20Websocket%20stream%20and%20send%20to%20Prometheus%20in%20Python&source=https%3a%2f%2fblacklabnz.github.io%2fposts%2fwebsocket-prometheus%2f"><i class="fab fa-linkedin-in fa-lg"></i></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blacklabnz.github.io/>blacklabnz | Data | DevOps</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>