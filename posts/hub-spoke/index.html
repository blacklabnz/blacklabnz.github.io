<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Azure networking: Hub and spoke topology with terraform | blacklabnz | Data | DevOps</title><meta name=keywords content="terraform,hub and spoke,private endpoints,azure firewall,forced tunneling"><meta name=description content="The hub and spoke topology has been widely adopted for enterprise production deployment. In this lab, let put on our network engineer hat and get our hand dirty on Azure Hub and spoke topology with one of the popular IaC &ndash; Terraform. Lets have a look at the high level architecture first. hubandspoke The essence of the topology is, but the name of it, having all traffic routed to hub network before forwarded to spoke network."><meta name=author content="blacklabnz"><link rel=canonical href=https://blacklabnz.github.io/posts/hub-spoke/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.807602952edefbeaea61e27642028a93d45bdbd0b38187ce18386944bb940374.css integrity="sha256-gHYClS7e++rqYeJ2QgKKk9Rb29CzgYfOGDhpRLuUA3Q=" rel="preload stylesheet" as=style><link rel=icon href=https://blacklabnz.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://blacklabnz.github.io/favicon16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blacklabnz.github.io/favicon32x32.png><link rel=mask-icon href=https://blacklabnz.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=G-FDV12HCDKK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FDV12HCDKK",{anonymize_ip:!1})}</script><meta property="og:title" content="Azure networking: Hub and spoke topology with terraform"><meta property="og:description" content="The hub and spoke topology has been widely adopted for enterprise production deployment. In this lab, let put on our network engineer hat and get our hand dirty on Azure Hub and spoke topology with one of the popular IaC &ndash; Terraform. Lets have a look at the high level architecture first. hubandspoke The essence of the topology is, but the name of it, having all traffic routed to hub network before forwarded to spoke network."><meta property="og:type" content="article"><meta property="og:url" content="https://blacklabnz.github.io/posts/hub-spoke/"><meta property="og:image" content="https://blacklabnz.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-11T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-11T00:00:00+00:00"><meta property="og:site_name" content="blacklabnz"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blacklabnz.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Azure networking: Hub and spoke topology with terraform"><meta name=twitter:description content="The hub and spoke topology has been widely adopted for enterprise production deployment. In this lab, let put on our network engineer hat and get our hand dirty on Azure Hub and spoke topology with one of the popular IaC &ndash; Terraform. Lets have a look at the high level architecture first. hubandspoke The essence of the topology is, but the name of it, having all traffic routed to hub network before forwarded to spoke network."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blacklabnz.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Azure networking: Hub and spoke topology with terraform","item":"https://blacklabnz.github.io/posts/hub-spoke/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Azure networking: Hub and spoke topology with terraform","name":"Azure networking: Hub and spoke topology with terraform","description":"The hub and spoke topology has been widely adopted for enterprise production deployment. In this lab, let put on our network engineer hat and get our hand dirty on Azure Hub and spoke topology with one of the popular IaC \u0026ndash; Terraform. Lets have a look at the high level architecture first. hubandspoke The essence of the topology is, but the name of it, having all traffic routed to hub network before forwarded to spoke network.","keywords":["terraform","hub and spoke","private endpoints","azure firewall","forced tunneling"],"articleBody":"The hub and spoke topology has been widely adopted for enterprise production deployment. In this lab, let put on our network engineer hat and get our hand dirty on Azure Hub and spoke topology with one of the popular IaC – Terraform. Lets have a look at the high level architecture first. hubandspoke The essence of the topology is, but the name of it, having all traffic routed to hub network before forwarded to spoke network. In hub network Azure firewall will be deployed, processing and logging all the traffic. In spoke user defined route is configured to route the traffic to hub, one the traffic arrives hub and processed by firewall, policy will be applied depending on the requirement to either allow or deny. We don’t have the luxury to have a on-prem VPN device with a VPN connection or express route, hence we are using another vNet and connect that to the hub via vNet gateway to simulate traffic passing through a gateway. Once we have the network all setup we will manually create some VMs to do some ping tests and the analyze the firewall logs using Azure Log analytics. Without further ado let dive into each part.\nPart 1 Hub network with firewall 1.1 Create vNet and subnets 1.2 Deploy firewall instance Part 2 Spoke networks and peering to hub 2.1 Create vNets and subnets 2.2 Setup peering to vNet Part 3 Another virtual network simulating on-prem via VPN 3.1 Create vNets and subnets 3.2 Create vNet to vNet VPN Part 4 Create some VMs to validate the traffic 4.1 Create some VMs 4.2 Ping tests Part 5 Azure log analytics analysis ","wordCount":"276","inLanguage":"en","datePublished":"2022-04-11T00:00:00Z","dateModified":"2022-04-11T00:00:00Z","author":{"@type":"Person","name":"blacklabnz"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blacklabnz.github.io/posts/hub-spoke/"},"publisher":{"@type":"Organization","name":"blacklabnz | Data | DevOps","logo":{"@type":"ImageObject","url":"https://blacklabnz.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><span class=header__inner><span class=logo><a href=https://blacklabnz.github.io/ accesskey=h title="blacklabnz (Alt + H)"><span><i class="fas fa-terminal fa-sm"></i></span>
<span class=logo_text>blacklabnz</span>
<span id=cursor></span></a></span>
<span class=header__right><div class=dropdown><span class=dropbtn><i class="fas fa-bars"></i></span><nav id=dropdonwBox class=dropdown-content><ul id=menu-mobile><li><a href=https://blacklabnz.github.io/posts title=blogs><span>blogs</span></a></li><li><a href=https://blacklabnz.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://blacklabnz.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://blacklabnz.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav><script src=/assets/js/menu.min.js></script></div><nav class=nav><ul id=menu><li><a href=https://blacklabnz.github.io/posts title=blogs><span>blogs</span></a></li><li><a href=https://blacklabnz.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://blacklabnz.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://blacklabnz.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav><ul class=logo-switches></ul><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></span></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blacklabnz.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://blacklabnz.github.io/posts/>Posts</a></div><h1 class=post-title>Azure networking: Hub and spoke topology with terraform</h1><div class=post-meta><span title="2022-04-11 00:00:00 +0000 UTC">Created April 11, 2022</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;blacklabnz&nbsp;|&nbsp;<a href=https://github.com/blacklabnz/blacklabnz.github.io/blob/main/content/posts/hub-spoke.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>The hub and spoke topology has been widely adopted for enterprise production deployment.
In this lab, let put on our network engineer hat and get our hand dirty on Azure Hub and spoke topology with one of the popular IaC &ndash; Terraform.
Lets have a look at the high level architecture first.
<a href>hubandspoke</a>
The essence of the topology is, but the name of it, having all traffic routed to hub network before forwarded to spoke network. In hub network Azure firewall will be deployed, processing and logging all the traffic.
In spoke user defined route is configured to route the traffic to hub, one the traffic arrives hub and processed by firewall, policy will be applied depending on the requirement to either allow or deny.
We don&rsquo;t have the luxury to have a on-prem VPN device with a VPN connection or express route, hence we are using another vNet and connect that to the hub via vNet gateway to simulate traffic passing through a gateway.
Once we have the network all setup we will manually create some VMs to do some ping tests and the analyze the firewall logs using Azure Log analytics.
Without further ado let dive into each part.</p><h2 id=part-1-hub-network-with-firewall>Part 1 Hub network with firewall<a hidden class=anchor aria-hidden=true href=#part-1-hub-network-with-firewall>#</a></h2><h3 id=11-create-vnet-and-subnets>1.1 Create vNet and subnets<a hidden class=anchor aria-hidden=true href=#11-create-vnet-and-subnets>#</a></h3><h3 id=12-deploy-firewall-instance>1.2 Deploy firewall instance<a hidden class=anchor aria-hidden=true href=#12-deploy-firewall-instance>#</a></h3><h2 id=part-2-spoke-networks-and-peering-to-hub>Part 2 Spoke networks and peering to hub<a hidden class=anchor aria-hidden=true href=#part-2-spoke-networks-and-peering-to-hub>#</a></h2><h3 id=21-create-vnets-and-subnets>2.1 Create vNets and subnets<a hidden class=anchor aria-hidden=true href=#21-create-vnets-and-subnets>#</a></h3><h3 id=22-setup-peering-to-vnet>2.2 Setup peering to vNet<a hidden class=anchor aria-hidden=true href=#22-setup-peering-to-vnet>#</a></h3><h2 id=part-3-another-virtual-network-simulating-on-prem-via-vpn>Part 3 Another virtual network simulating on-prem via VPN<a hidden class=anchor aria-hidden=true href=#part-3-another-virtual-network-simulating-on-prem-via-vpn>#</a></h2><h3 id=31-create-vnets-and-subnets>3.1 Create vNets and subnets<a hidden class=anchor aria-hidden=true href=#31-create-vnets-and-subnets>#</a></h3><h3 id=32-create-vnet-to-vnet-vpn>3.2 Create vNet to vNet VPN<a hidden class=anchor aria-hidden=true href=#32-create-vnet-to-vnet-vpn>#</a></h3><h2 id=part-4-create-some-vms-to-validate-the-traffic>Part 4 Create some VMs to validate the traffic<a hidden class=anchor aria-hidden=true href=#part-4-create-some-vms-to-validate-the-traffic>#</a></h2><h3 id=41-create-some-vms>4.1 Create some VMs<a hidden class=anchor aria-hidden=true href=#41-create-some-vms>#</a></h3><h3 id=42-ping-tests>4.2 Ping tests<a hidden class=anchor aria-hidden=true href=#42-ping-tests>#</a></h3><h2 id=part-5-azure-log-analytics-analysis>Part 5 Azure log analytics analysis<a hidden class=anchor aria-hidden=true href=#part-5-azure-log-analytics-analysis>#</a></h2></div><footer class=post-footer><ul class=post-tags><li><i class="fas fa-tags fa-sm"></i></li><li><a href=https://blacklabnz.github.io/tags/terraform/>terraform</a></li><li><a href=https://blacklabnz.github.io/tags/hub-and-spoke/>hub and spoke</a></li><li><a href=https://blacklabnz.github.io/tags/private-endpoints/>private endpoints</a></li><li><a href=https://blacklabnz.github.io/tags/azure-firewall/>azure firewall</a></li><li><a href=https://blacklabnz.github.io/tags/forced-tunneling/>forced tunneling</a></li></ul><nav class=paginav><a class=prev href=https://blacklabnz.github.io/posts/websocket-prometheus/><span class=title>« Prev Page</span><br><span>Consume Websocket stream and send to Prometheus in Python</span></a>
<a class=next href=https://blacklabnz.github.io/posts/databricks-secure/><span class=title>Next Page »</span><br><span>Secure Databricks cluster with vNet injection and access resources via Azure private endpoint</span></a></nav><div class=share-buttons><a>Share via:</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Azure networking: Hub and spoke topology with terraform on twitter" href="https://twitter.com/intent/tweet/?text=Azure%20networking%3a%20Hub%20and%20spoke%20topology%20with%20terraform&url=https%3a%2f%2fblacklabnz.github.io%2fposts%2fhub-spoke%2f&hashtags=terraform%2chubandspoke%2cprivateendpoints%2cazurefirewall%2cforcedtunneling"><i class="fab fa-twitter fa-lg"></i></a>
<a target=_blank rel="noopener noreferrer" aria-label="share Azure networking: Hub and spoke topology with terraform on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblacklabnz.github.io%2fposts%2fhub-spoke%2f&title=Azure%20networking%3a%20Hub%20and%20spoke%20topology%20with%20terraform&summary=Azure%20networking%3a%20Hub%20and%20spoke%20topology%20with%20terraform&source=https%3a%2f%2fblacklabnz.github.io%2fposts%2fhub-spoke%2f"><i class="fab fa-linkedin-in fa-lg"></i></a></div></footer><div id=page-comments><script src=https://utteranc.es/client.js repo=blacklabnz/blacklabnz.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><script src=/assets/js/utterance-theme.min.js></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://blacklabnz.github.io/>blacklabnz</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><i class="fas fa-chevron-circle-up fa-2x"></i></a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>